# Deploy Hooks Parameters

All right, we've got the basics of deployment behind us, our code is getting up to the server. The Ansistrano's taken care of doing the symbolic link to the current directory. It's already a very good set up. What we have left are the things specific to our application, like configuring database credentials, running composer install. Those things are up to us. Fortunately, they're pretty easy.

If you scroll up to the top of the Ansistrano documentation, I want you to find Main Workflow, because we need to learn a little bit more about how Ansistrano works. It actually has five different stages: set-up, update code, symlink shared, symlink, and clean up. The cool thing is we can actually hook and add our own custom tasks, before or after any of these stages. So that's gonna be our way to run things like composer install and set up parameters.yml.

Now there are three important things that I want us to notice about this structure. The first one is update code. That's when our code is actually pulled down to the server. Simple. The fourth one, symlink, that's when it actually creates the symbolic link from the current directory to whatever the latest release is. And at the moment, our site becomes live, and we start serving things from the current directory.

But there's another one called symlink shared. This is something that I want to talk about now, but we're not gonna see until later. Right now all of our releases are completely separate, so you can see we have three releases, and they're all three separate directories. But sometimes, you want certain files to be shared across deployments. For example, if you have a log file, you don't want that log file to be completely new on every deploy. You'd rather there be one log file, and every new release automatically uses that log file. The way that's done is via the shared directory. The shared directory is empty right now. But with Ansistrano, what you can do, is you can configure certain files or directories to be shared. And in that case, what will happen is it will create the file, or directory, in shared. And then when ever you deploy, it will create a symbolic link from the specific release directory, to that shared directory.

For example, eventually we're gonna want to have the current/var/logs directory of our project, which is where our log files are stored by default, we're gonna want that to be shared. Once we have that set up, the way that will look is that we'll have a var/logs directory inside of shared, and each individual release, instead of having that directory, will just have a symbolic link back to that one spot. We're going to see this in action later, but you need to understand that that is possible right now. Looking back here, we pull the code down into the new release directory. We symbolically link any shared files to the shared directory. And then we symbolically link the release to the current directory, and make our site live.

Now if you Google Symfony deployment basics, you should find Symfony's deployment article, where it lists the basic things that you need to do to deploy a Symfony application, like uploading your code to the production server. Done. Installing your vendor dependencies, and a number of other things, like your parameters files, app/config/parameters.yml. That's going to need to be set up on our server. So that's what we're going to set up right now.

Make sure on the server there is an app/config/parameters.yml file. Because guess what, if we go into our current directory right now, there is no parameters.yml file, just parameters.yml.dist. Alright, so how can we add a custom hook? Because need to somehow create that file. The answer is back in our Ansistrano configuration. To hook before or after any of these stages, there are variables, and you can see them all the way down at the bottom here. You basically override a variable based on what you wanna hook into, and you point it to a custom file, where we can put whatever tasks we want. I want you to copy the Ansistrano after_symlink_shared_tasks file. That's the hook I'm going to hook into. Because this will be after all of our shared files are symbolically linked, but before our site becomes live. We'll be right here. So our code is basically ready, but our site isn't live yet. So this is a perfect spot for us to do some custom things.

So inside of our deploy.yml, I'll paste that, and I'm gonna set it to playbook_dir. And then I'm gonna point this at a new file, inside the new directory, /deploy/after-symlink-shared.yml. So I'll copy that file name, and outside ansible let's create a new deploy directory, and inside there, the new after-symlink-shared.yml.

Alright, so the next question is, how do we create the parameters.yml file up on the server? There are two options. The easier, but less automated one is, we could configure Ansistrano to make the parameters.yml file shared. And that would mean that on our next deploy, there would be a parameters.yml file, but it would be empty. It would live in the shared directory. We could then go up to the server by hand, change the parameters.yml file, and change our parameters.yml file. And as soon as we did that, all future deploys would use that parameters.yml file. But, it requires to set that file up by hand, and any time that files needs to change, we'll need to change that file by hand.

So instead, I like to create my parameters.yml file through ansible. And here's what we're gonna do. Inside the ansible directory, create a new templates directory, and then copy the app/config/parameters.yml.dist from your main project, and put it inside of templates. What we're gonna do here, is we're actually going to customize this file using ansible variables, and this is gonna be the file that we actually deploy to the server, so stay with me. Right now, I'm gonna keep everything just hard coded with the fake values. Now, in our after-symlink-shared, we're gonna add a new task, called set up infrastructure-related parameters. We're gonna use the template module to basically, for now, copy up playbook_dir/templates/parameters.yml.dist, and we're gonna copy that up into our release.

Now the only problem is, how do we know what directory on the system our release is in? Because our releases always have a new number directory. And remember we are running this code before the current symbolic link has happened, so we can't use the var/www/project/current. Well the answer is, if you look at the Ansistrano documentation, search for Ansistrano release path. You'll find a section near the bottom called, variables in custom tasks. And this is a spot that tells you a couple variables that are available to us, that might be useful.

This first one here is very useful. This is the directory that we're deploying to right now. Another one that might be useful is the shared path, and the release version, if you ever need to make something custom based on the release version. Alright, so we can set the destination to {{ ansistrano_release_path.stdout }}/app/config/parameters.yml. So not customizing anything yet inside of our new parameters.yml.dist file, but we should have enough now to actually put that up on the server. So, let's try it. Rerun your deploy.

Alright, finished without any errors. And if you move over now, go into your current directory, now we have a parameters.yml file. And it's equal to our hard coded information. That was a good step one, now we need to actually make our parameters.yml file dynamic, so it actually can include our production specific configuration. And we need to do that in a secure way, so let's do it next.

